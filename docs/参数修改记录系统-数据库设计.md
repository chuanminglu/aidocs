# 自动化参数修改记录系统 - MySQL 数据库设计文档

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| 数据库类型 | MySQL 8.0+ |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_unicode_ci |
| 存储引擎 | InnoDB |
| 文档版本 | 1.0 |
| 创建日期 | 2025-01-16 |
| 最后更新 | 2025-01-16 |

---

## 📊 数据库概览

### 数据库名称
```sql
CREATE DATABASE IF NOT EXISTS `automation_param_system` 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE `automation_param_system`;
```

### 数据表清单

| 序号 | 表名 | 说明 | 记录数估算 |
|------|------|------|-----------|
| 1 | `sys_site` | 运行现场信息表 | 50-100 |
| 2 | `sys_automation_system` | 自动化系统信息表 | 100-500 |
| 3 | `sys_department` | 维护部门信息表 | 20-50 |
| 4 | `param_modification_record` | 参数修改记录主表 | 10,000+ |
| 5 | `param_modification_detail` | 参数修改详情表 | 50,000+ |
| 6 | `param_version_history` | 参数版本历史表 | 100,000+ |
| 7 | `sys_user` | 系统用户表 | 50-200 |
| 8 | `sys_role` | 角色表 | 5-10 |
| 9 | `sys_permission` | 权限表 | 20-50 |
| 10 | `sys_operation_log` | 操作日志表 | 100,000+ |

---

## 📐 表结构设计

### 1. 运行现场信息表 (sys_site)

**功能说明**: 存储系统部署的地理位置信息

```sql
CREATE TABLE `sys_site` (
  `site_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '现场ID',
  `site_code` VARCHAR(50) NOT NULL COMMENT '现场编码',
  `site_name` VARCHAR(100) NOT NULL COMMENT '现场名称',
  `site_location` VARCHAR(200) DEFAULT NULL COMMENT '详细地址',
  `province` VARCHAR(50) DEFAULT NULL COMMENT '省份',
  `city` VARCHAR(50) DEFAULT NULL COMMENT '城市',
  `contact_person` VARCHAR(50) DEFAULT NULL COMMENT '联系人',
  `contact_phone` VARCHAR(20) DEFAULT NULL COMMENT '联系电话',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-停用, 1-启用',
  `sort_order` INT DEFAULT 0 COMMENT '排序序号',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_by` INT UNSIGNED DEFAULT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` INT UNSIGNED DEFAULT NULL COMMENT '更新人ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`site_id`),
  UNIQUE KEY `uk_site_code` (`site_code`),
  KEY `idx_city` (`city`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='运行现场信息表';
```

**示例数据**:
```sql
INSERT INTO `sys_site` (`site_code`, `site_name`, `city`, `status`) VALUES
('GZ001', '广州', '广州', 1),
('ZZ001', '郑州', '郑州', 1);
```

---

### 2. 自动化系统信息表 (sys_automation_system)

**功能说明**: 存储自动化系统的基本信息

```sql
CREATE TABLE `sys_automation_system` (
  `system_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '系统ID',
  `system_code` VARCHAR(50) NOT NULL COMMENT '系统编码',
  `system_name` VARCHAR(200) NOT NULL COMMENT '系统名称',
  `site_id` INT UNSIGNED NOT NULL COMMENT '所属现场ID',
  `department_id` INT UNSIGNED DEFAULT NULL COMMENT '维护部门ID',
  `system_type` VARCHAR(50) DEFAULT NULL COMMENT '系统类型',
  `role_type` ENUM('主用', '备用') NOT NULL DEFAULT '主用' COMMENT '主备角色',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
  `port` INT DEFAULT NULL COMMENT '端口号',
  `version` VARCHAR(50) DEFAULT NULL COMMENT '系统版本',
  `vendor` VARCHAR(100) DEFAULT NULL COMMENT '厂商',
  `install_date` DATE DEFAULT NULL COMMENT '安装日期',
  `warranty_date` DATE DEFAULT NULL COMMENT '保修期至',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-离线, 1-在线, 2-维护中',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_by` INT UNSIGNED DEFAULT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` INT UNSIGNED DEFAULT NULL COMMENT '更新人ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`system_id`),
  UNIQUE KEY `uk_system_code` (`system_code`),
  KEY `idx_site_id` (`site_id`),
  KEY `idx_department_id` (`department_id`),
  KEY `idx_role_type` (`role_type`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_system_site` FOREIGN KEY (`site_id`) REFERENCES `sys_site` (`site_id`),
  CONSTRAINT `fk_system_department` FOREIGN KEY (`department_id`) REFERENCES `sys_department` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='自动化系统信息表';
```

**示例数据**:
```sql
INSERT INTO `sys_automation_system` (`system_code`, `system_name`, `site_id`, `role_type`) VALUES
('SYS001', '秦雷丝', 1, '主用'),
('SYS002', '系统名称系统名称系统名称', 2, '备用');
```

---

### 3. 维护部门信息表 (sys_department)

**功能说明**: 存储负责维护的部门信息

```sql
CREATE TABLE `sys_department` (
  `department_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '部门ID',
  `department_code` VARCHAR(50) NOT NULL COMMENT '部门编码',
  `department_name` VARCHAR(100) NOT NULL COMMENT '部门名称',
  `parent_id` INT UNSIGNED DEFAULT NULL COMMENT '上级部门ID',
  `department_level` TINYINT DEFAULT 1 COMMENT '部门层级',
  `leader_name` VARCHAR(50) DEFAULT NULL COMMENT '部门负责人',
  `leader_phone` VARCHAR(20) DEFAULT NULL COMMENT '负责人电话',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-停用, 1-启用',
  `sort_order` INT DEFAULT 0 COMMENT '排序序号',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_by` INT UNSIGNED DEFAULT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` INT UNSIGNED DEFAULT NULL COMMENT '更新人ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`department_id`),
  UNIQUE KEY `uk_department_code` (`department_code`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='维护部门信息表';
```

**示例数据**:
```sql
INSERT INTO `sys_department` (`department_code`, `department_name`) VALUES
('DEPT001', '部门名称');
```

---

### 4. 参数修改记录主表 (param_modification_record)

**功能说明**: 存储参数修改的汇总记录（对应界面列表显示）

```sql
CREATE TABLE `param_modification_record` (
  `record_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `system_id` INT UNSIGNED NOT NULL COMMENT '系统ID',
  `site_id` INT UNSIGNED NOT NULL COMMENT '现场ID',
  `department_id` INT UNSIGNED DEFAULT NULL COMMENT '维护部门ID',
  `modification_count` INT NOT NULL DEFAULT 0 COMMENT '参数修改次数',
  `last_modified_at` DATETIME DEFAULT NULL COMMENT '最后修改时间',
  `last_modified_by` INT UNSIGNED DEFAULT NULL COMMENT '最后修改人ID',
  `last_modified_by_name` VARCHAR(50) DEFAULT NULL COMMENT '最后修改人姓名（冗余字段）',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-无效, 1-有效',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_by` INT UNSIGNED DEFAULT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` INT UNSIGNED DEFAULT NULL COMMENT '更新人ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`record_id`),
  KEY `idx_system_id` (`system_id`),
  KEY `idx_site_id` (`site_id`),
  KEY `idx_department_id` (`department_id`),
  KEY `idx_last_modified_at` (`last_modified_at`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_record_system` FOREIGN KEY (`system_id`) REFERENCES `sys_automation_system` (`system_id`),
  CONSTRAINT `fk_record_site` FOREIGN KEY (`site_id`) REFERENCES `sys_site` (`site_id`),
  CONSTRAINT `fk_record_department` FOREIGN KEY (`department_id`) REFERENCES `sys_department` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='参数修改记录主表';
```

**字段说明**:
- `modification_count`: 对应界面的"参数记录数"列
- `last_modified_at`: 对应界面的"更新时间"列

---

### 5. 参数修改详情表 (param_modification_detail)

**功能说明**: 存储每次参数修改的详细信息

```sql
CREATE TABLE `param_modification_detail` (
  `detail_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '详情ID',
  `record_id` BIGINT UNSIGNED NOT NULL COMMENT '记录ID（关联主表）',
  `system_id` INT UNSIGNED NOT NULL COMMENT '系统ID（冗余字段，便于查询）',
  `modification_type` VARCHAR(50) NOT NULL COMMENT '修改类型: 新增/修改/删除',
  `param_category` VARCHAR(100) DEFAULT NULL COMMENT '参数分类',
  `param_name` VARCHAR(200) NOT NULL COMMENT '参数名称',
  `param_code` VARCHAR(100) DEFAULT NULL COMMENT '参数编码',
  `old_value` TEXT DEFAULT NULL COMMENT '修改前值',
  `new_value` TEXT DEFAULT NULL COMMENT '修改后值',
  `value_type` VARCHAR(50) DEFAULT NULL COMMENT '值类型: string/int/float/boolean/json',
  `unit` VARCHAR(20) DEFAULT NULL COMMENT '单位',
  `modification_reason` VARCHAR(500) DEFAULT NULL COMMENT '修改原因',
  `approval_status` TINYINT DEFAULT 0 COMMENT '审批状态: 0-待审批, 1-已通过, 2-已拒绝',
  `approver_id` INT UNSIGNED DEFAULT NULL COMMENT '审批人ID',
  `approved_at` DATETIME DEFAULT NULL COMMENT '审批时间',
  `effective_status` TINYINT DEFAULT 1 COMMENT '生效状态: 0-未生效, 1-已生效, 2-已失效',
  `effective_at` DATETIME DEFAULT NULL COMMENT '生效时间',
  `modified_by` INT UNSIGNED NOT NULL COMMENT '修改人ID',
  `modified_by_name` VARCHAR(50) DEFAULT NULL COMMENT '修改人姓名',
  `modified_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
  `remark` VARCHAR(1000) DEFAULT NULL COMMENT '备注',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`detail_id`),
  KEY `idx_record_id` (`record_id`),
  KEY `idx_system_id` (`system_id`),
  KEY `idx_param_name` (`param_name`),
  KEY `idx_modified_at` (`modified_at`),
  KEY `idx_approval_status` (`approval_status`),
  CONSTRAINT `fk_detail_record` FOREIGN KEY (`record_id`) REFERENCES `param_modification_record` (`record_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='参数修改详情表';
```

---

### 6. 参数版本历史表 (param_version_history)

**功能说明**: 存储参数的完整版本历史，支持版本对比

```sql
CREATE TABLE `param_version_history` (
  `version_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '版本ID',
  `detail_id` BIGINT UNSIGNED NOT NULL COMMENT '详情ID（关联详情表）',
  `system_id` INT UNSIGNED NOT NULL COMMENT '系统ID',
  `param_name` VARCHAR(200) NOT NULL COMMENT '参数名称',
  `param_value` TEXT NOT NULL COMMENT '参数值',
  `version_number` INT NOT NULL COMMENT '版本号',
  `is_current` TINYINT NOT NULL DEFAULT 0 COMMENT '是否当前版本: 0-否, 1-是',
  `change_description` VARCHAR(500) DEFAULT NULL COMMENT '变更说明',
  `modified_by` INT UNSIGNED NOT NULL COMMENT '修改人ID',
  `modified_at` DATETIME NOT NULL COMMENT '修改时间',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`version_id`),
  KEY `idx_detail_id` (`detail_id`),
  KEY `idx_system_param` (`system_id`, `param_name`),
  KEY `idx_version_number` (`version_number`),
  KEY `idx_is_current` (`is_current`),
  CONSTRAINT `fk_version_detail` FOREIGN KEY (`detail_id`) REFERENCES `param_modification_detail` (`detail_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='参数版本历史表';
```

---

### 7. 系统用户表 (sys_user)

**功能说明**: 存储系统用户信息

```sql
CREATE TABLE `sys_user` (
  `user_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
  `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
  `employee_no` VARCHAR(50) DEFAULT NULL COMMENT '工号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `department_id` INT UNSIGNED DEFAULT NULL COMMENT '所属部门ID',
  `position` VARCHAR(50) DEFAULT NULL COMMENT '职位',
  `role_ids` VARCHAR(200) DEFAULT NULL COMMENT '角色ID列表（逗号分隔）',
  `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
  `last_login_at` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
  `login_count` INT DEFAULT 0 COMMENT '登录次数',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-禁用, 1-启用',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_by` INT UNSIGNED DEFAULT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` INT UNSIGNED DEFAULT NULL COMMENT '更新人ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`user_id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_department_id` (`department_id`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_user_department` FOREIGN KEY (`department_id`) REFERENCES `sys_department` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统用户表';
```

---

### 8. 角色表 (sys_role)

**功能说明**: 存储系统角色信息

```sql
CREATE TABLE `sys_role` (
  `role_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `role_code` VARCHAR(50) NOT NULL COMMENT '角色编码',
  `role_name` VARCHAR(50) NOT NULL COMMENT '角色名称',
  `role_level` TINYINT DEFAULT 1 COMMENT '角色层级',
  `description` VARCHAR(200) DEFAULT NULL COMMENT '角色描述',
  `permission_ids` TEXT DEFAULT NULL COMMENT '权限ID列表（逗号分隔）',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-停用, 1-启用',
  `sort_order` INT DEFAULT 0 COMMENT '排序序号',
  `created_by` INT UNSIGNED DEFAULT NULL COMMENT '创建人ID',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` INT UNSIGNED DEFAULT NULL COMMENT '更新人ID',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除: 0-未删除, 1-已删除',
  PRIMARY KEY (`role_id`),
  UNIQUE KEY `uk_role_code` (`role_code`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色表';
```

**预置角色数据**:
```sql
INSERT INTO `sys_role` (`role_code`, `role_name`, `description`) VALUES
('ADMIN', '系统管理员', '拥有所有权限'),
('OPERATOR', '系统操作员', '可以添加和修改参数'),
('VIEWER', '查看者', '仅可查看数据');
```

---

### 9. 权限表 (sys_permission)

**功能说明**: 存储系统权限信息

```sql
CREATE TABLE `sys_permission` (
  `permission_id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `permission_code` VARCHAR(100) NOT NULL COMMENT '权限编码',
  `permission_name` VARCHAR(100) NOT NULL COMMENT '权限名称',
  `permission_type` TINYINT NOT NULL COMMENT '权限类型: 1-菜单, 2-功能, 3-数据',
  `parent_id` INT UNSIGNED DEFAULT NULL COMMENT '父权限ID',
  `resource_path` VARCHAR(200) DEFAULT NULL COMMENT '资源路径',
  `description` VARCHAR(200) DEFAULT NULL COMMENT '权限描述',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0-停用, 1-启用',
  `sort_order` INT DEFAULT 0 COMMENT '排序序号',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`permission_id`),
  UNIQUE KEY `uk_permission_code` (`permission_code`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='权限表';
```

**预置权限数据**:
```sql
INSERT INTO `sys_permission` (`permission_code`, `permission_name`, `permission_type`) VALUES
('param:view', '查看参数记录', 2),
('param:add', '添加参数记录', 2),
('param:edit', '编辑参数记录', 2),
('param:delete', '删除参数记录', 2),
('param:export', '导出参数记录', 2),
('param:approve', '审批参数修改', 2);
```

---

### 10. 操作日志表 (sys_operation_log)

**功能说明**: 记录所有用户操作，支持审计追溯

```sql
CREATE TABLE `sys_operation_log` (
  `log_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` INT UNSIGNED DEFAULT NULL COMMENT '操作人ID',
  `username` VARCHAR(50) DEFAULT NULL COMMENT '操作人用户名',
  `operation_module` VARCHAR(50) NOT NULL COMMENT '操作模块',
  `operation_type` VARCHAR(50) NOT NULL COMMENT '操作类型: 增/删/改/查/导出/登录等',
  `operation_desc` VARCHAR(500) DEFAULT NULL COMMENT '操作描述',
  `request_method` VARCHAR(10) DEFAULT NULL COMMENT '请求方法: GET/POST/PUT/DELETE',
  `request_url` VARCHAR(500) DEFAULT NULL COMMENT '请求URL',
  `request_params` TEXT DEFAULT NULL COMMENT '请求参数（JSON格式）',
  `response_status` INT DEFAULT NULL COMMENT '响应状态码',
  `response_message` VARCHAR(500) DEFAULT NULL COMMENT '响应消息',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '操作IP',
  `browser` VARCHAR(100) DEFAULT NULL COMMENT '浏览器',
  `os` VARCHAR(100) DEFAULT NULL COMMENT '操作系统',
  `execution_time` INT DEFAULT NULL COMMENT '执行时长（毫秒）',
  `error_message` TEXT DEFAULT NULL COMMENT '错误信息',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  PRIMARY KEY (`log_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

---

## 📊 视图设计

### 1. 参数修改记录列表视图 (v_param_modification_list)

**功能说明**: 对应界面列表显示，整合多表数据

```sql
CREATE OR REPLACE VIEW `v_param_modification_list` AS
SELECT 
    pmr.record_id,
    ss.site_name AS site_name,
    sas.system_name AS system_name,
    sas.role_type AS role_type,
    sd.department_name AS department_name,
    pmr.modification_count AS param_count,
    pmr.last_modified_at AS update_time,
    pmr.last_modified_by_name AS modifier_name,
    ss.site_id,
    sas.system_id,
    sd.department_id
FROM 
    param_modification_record pmr
    LEFT JOIN sys_automation_system sas ON pmr.system_id = sas.system_id
    LEFT JOIN sys_site ss ON pmr.site_id = ss.site_id
    LEFT JOIN sys_department sd ON pmr.department_id = sd.department_id
WHERE 
    pmr.deleted = 0
    AND sas.deleted = 0;
```

**使用示例**:
```sql
-- 查询列表（对应界面显示）
SELECT * FROM v_param_modification_list
ORDER BY update_time DESC
LIMIT 10 OFFSET 10;  -- 第2页，每页10条

-- 按现场筛选
SELECT * FROM v_param_modification_list
WHERE site_name IN ('广州', '郑州');

-- 多条件筛选
SELECT * FROM v_param_modification_list
WHERE site_name = '广州'
  AND system_name LIKE '%秦雷丝%'
  AND role_type = '主用';
```

---

### 2. 参数修改详情视图 (v_param_modification_detail)

**功能说明**: 查看参数修改的详细信息

```sql
CREATE OR REPLACE VIEW `v_param_modification_detail` AS
SELECT 
    pmd.detail_id,
    pmd.record_id,
    sas.system_name,
    ss.site_name,
    pmd.modification_type,
    pmd.param_category,
    pmd.param_name,
    pmd.old_value,
    pmd.new_value,
    pmd.modification_reason,
    pmd.approval_status,
    pmd.modified_by_name,
    pmd.modified_at,
    u.real_name AS approver_name,
    pmd.approved_at
FROM 
    param_modification_detail pmd
    LEFT JOIN param_modification_record pmr ON pmd.record_id = pmr.record_id
    LEFT JOIN sys_automation_system sas ON pmd.system_id = sas.system_id
    LEFT JOIN sys_site ss ON pmr.site_id = ss.site_id
    LEFT JOIN sys_user u ON pmd.approver_id = u.user_id;
```

---

## 🔍 索引优化建议

### 复合索引

```sql
-- param_modification_record 表
ALTER TABLE param_modification_record 
ADD INDEX idx_site_system_time (site_id, system_id, last_modified_at);

-- param_modification_detail 表
ALTER TABLE param_modification_detail 
ADD INDEX idx_system_param_time (system_id, param_name, modified_at);

-- sys_operation_log 表
ALTER TABLE sys_operation_log 
ADD INDEX idx_user_operation_time (user_id, operation_type, created_at);
```

### 全文索引（用于参数名称搜索）

```sql
ALTER TABLE param_modification_detail 
ADD FULLTEXT INDEX ft_param_name (param_name);

-- 使用示例
SELECT * FROM param_modification_detail
WHERE MATCH(param_name) AGAINST('速度 温度' IN NATURAL LANGUAGE MODE);
```

---

## 🔐 数据安全设计

### 1. 敏感数据加密

```sql
-- 密码字段使用 bcrypt 或 argon2 算法加密
-- 示例（在应用层处理）:
-- password: bcrypt.hash(password, 10)

-- 敏感参数值加密存储
ALTER TABLE param_modification_detail 
ADD COLUMN `encrypted` TINYINT DEFAULT 0 COMMENT '是否加密: 0-否, 1-是';
```

### 2. 审计触发器

```sql
-- 参数修改时自动更新主表计数
DELIMITER $$
CREATE TRIGGER tr_update_modification_count
AFTER INSERT ON param_modification_detail
FOR EACH ROW
BEGIN
    UPDATE param_modification_record
    SET modification_count = modification_count + 1,
        last_modified_at = NEW.modified_at,
        last_modified_by = NEW.modified_by,
        last_modified_by_name = NEW.modified_by_name
    WHERE record_id = NEW.record_id;
END$$
DELIMITER ;
```

### 3. 操作日志触发器

```sql
-- 记录参数修改操作日志
DELIMITER $$
CREATE TRIGGER tr_log_param_modification
AFTER INSERT ON param_modification_detail
FOR EACH ROW
BEGIN
    INSERT INTO sys_operation_log (
        user_id,
        username,
        operation_module,
        operation_type,
        operation_desc,
        created_at
    ) VALUES (
        NEW.modified_by,
        NEW.modified_by_name,
        'param_modification',
        NEW.modification_type,
        CONCAT('修改参数: ', NEW.param_name),
        NEW.modified_at
    );
END$$
DELIMITER ;
```

---

## 📈 查询优化示例

### 1. 分页查询（高性能）

```sql
-- 推荐方式（使用主键范围）
SELECT * FROM v_param_modification_list
WHERE record_id > (
    SELECT record_id FROM v_param_modification_list
    ORDER BY record_id LIMIT 1 OFFSET 10
)
ORDER BY record_id
LIMIT 10;

-- 传统方式（性能较差）
SELECT * FROM v_param_modification_list
ORDER BY update_time DESC
LIMIT 10 OFFSET 10;
```

### 2. 多条件查询

```sql
-- 动态 SQL 示例（应用层实现）
SELECT * FROM v_param_modification_list
WHERE 1=1
  AND (NULLIF(:site_name, '') IS NULL OR site_name = :site_name)
  AND (NULLIF(:system_name, '') IS NULL OR system_name LIKE CONCAT('%', :system_name, '%'))
  AND (NULLIF(:role_type, '') IS NULL OR role_type = :role_type)
  AND (NULLIF(:department_name, '') IS NULL OR department_name = :department_name)
ORDER BY update_time DESC
LIMIT :limit OFFSET :offset;
```

### 3. 统计查询

```sql
-- 按现场统计参数修改次数
SELECT 
    ss.site_name,
    COUNT(pmr.record_id) AS record_count,
    SUM(pmr.modification_count) AS total_modifications
FROM sys_site ss
LEFT JOIN param_modification_record pmr ON ss.site_id = pmr.site_id
WHERE ss.deleted = 0
GROUP BY ss.site_id, ss.site_name;

-- 按系统统计
SELECT 
    sas.system_name,
    sas.role_type,
    COUNT(pmd.detail_id) AS detail_count,
    MAX(pmd.modified_at) AS last_modified_at
FROM sys_automation_system sas
LEFT JOIN param_modification_detail pmd ON sas.system_id = pmd.system_id
GROUP BY sas.system_id, sas.system_name, sas.role_type;
```

---

## 🗄️ 数据归档策略

### 归档表设计

```sql
-- 创建归档表（与原表结构相同）
CREATE TABLE `param_modification_detail_archive` LIKE `param_modification_detail`;

-- 添加归档时间字段
ALTER TABLE `param_modification_detail_archive`
ADD COLUMN `archived_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '归档时间';
```

### 归档存储过程

```sql
DELIMITER $$
CREATE PROCEDURE sp_archive_old_data(IN p_days INT)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'Archive failed' AS result;
    END;
    
    START TRANSACTION;
    
    -- 归档 N 天前的数据
    INSERT INTO param_modification_detail_archive
    SELECT *, NOW() AS archived_at
    FROM param_modification_detail
    WHERE modified_at < DATE_SUB(NOW(), INTERVAL p_days DAY);
    
    -- 删除已归档数据
    DELETE FROM param_modification_detail
    WHERE modified_at < DATE_SUB(NOW(), INTERVAL p_days DAY);
    
    COMMIT;
    SELECT 'Archive successful' AS result;
END$$
DELIMITER ;

-- 执行归档（归档1年前的数据）
CALL sp_archive_old_data(365);
```

---

## 💾 备份策略

### 1. 定期备份

```bash
#!/bin/bash
# 每日备份脚本

BACKUP_DIR="/backup/mysql"
DB_NAME="automation_param_system"
DATE=$(date +%Y%m%d_%H%M%S)

mysqldump -u root -p${DB_PASSWORD} \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    ${DB_NAME} > ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql

# 压缩备份文件
gzip ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql

# 删除7天前的备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +7 -delete
```

### 2. 增量备份

```bash
# 启用二进制日志
# my.cnf 配置
[mysqld]
log-bin=mysql-bin
binlog-format=ROW
expire_logs_days=7

# 增量备份脚本
mysqlbinlog mysql-bin.000001 > incremental_backup.sql
```

---

## 📊 性能监控

### 慢查询日志

```sql
-- my.cnf 配置
[mysqld]
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2

-- 分析慢查询
SELECT * FROM mysql.slow_log
ORDER BY query_time DESC
LIMIT 10;
```

### 表统计信息

```sql
-- 查看表大小
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
    table_rows
FROM information_schema.TABLES
WHERE table_schema = 'automation_param_system'
ORDER BY size_mb DESC;

-- 查看索引使用情况
SELECT 
    table_name,
    index_name,
    cardinality,
    seq_in_index
FROM information_schema.STATISTICS
WHERE table_schema = 'automation_param_system'
ORDER BY table_name, index_name;
```

---

## 🔧 维护建议

### 1. 定期优化

```sql
-- 分析表
ANALYZE TABLE param_modification_record;
ANALYZE TABLE param_modification_detail;

-- 优化表
OPTIMIZE TABLE param_modification_record;
OPTIMIZE TABLE param_modification_detail;

-- 检查表
CHECK TABLE param_modification_record;
```

### 2. 数据清理

```sql
-- 清理逻辑删除的数据（定期执行）
DELETE FROM sys_site WHERE deleted = 1 AND updated_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
DELETE FROM sys_automation_system WHERE deleted = 1 AND updated_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### 3. 监控建议

- 监控表空间大小
- 监控慢查询数量
- 监控连接数
- 监控锁等待
- 定期审查索引使用率

---

## 📝 附录

### A. ER 图说明

```
sys_site (运行现场)
    ↓ 1:N
sys_automation_system (自动化系统)
    ↓ 1:N
param_modification_record (参数修改记录)
    ↓ 1:N
param_modification_detail (参数修改详情)
    ↓ 1:N
param_version_history (版本历史)

sys_department (维护部门)
    ↓ 1:N
sys_user (系统用户)
    ↓ N:M (通过 role_ids)
sys_role (角色)
    ↓ N:M (通过 permission_ids)
sys_permission (权限)
```

### B. 命名规范

- 表名：小写字母+下划线，使用前缀区分模块（sys_、param_）
- 字段名：小写字母+下划线
- 索引名：idx_ + 字段名
- 唯一索引：uk_ + 字段名
- 外键：fk_ + 表名简写 + 字段名

### C. 数据字典

详细的数据字典请参考各表结构说明。

---

**文档版本**: 1.0  
**创建日期**: 2025-01-16  
**维护人**: 数据库管理员  
**审核状态**: 待审核
